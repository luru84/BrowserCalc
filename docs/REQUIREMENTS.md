# 要件定義（Web電卓）

## 目的
ブラウザ上で、一般的な電卓の基本機能（四則演算・メモリ機能）を提供し、日常の簡易計算を手軽に行えるようにする。

## スコープ
- 対象: PC/スマホの主要ブラウザで利用する個人ユーザー向け簡易電卓。
- 提供形態: シングルページ（クライアントサイドのみ、サーバー常時連携なし）。

## ユースケース（例）
- 簡単な足し算・引き算・掛け算・割り算を素早く行う。
- 計算途中でメモリに値を保持し、再利用する。
- 入力ミスを一文字だけ取り消す、もしくは全クリアする。
- 直近の計算を連続して実行（= を繰り返して同じ演算を適用）。

## 機能要件
- 表示:
  - 現在の入力・結果を表示（桁区切り/科学表記は初期スコープ外、必要なら拡張）。
  - 直前の演算子やメモリ状態を示すインジケータを設置（例: `M` 表示）。
- 入力:
  - 数値: 0-9、10進小数点。
  - 符号反転: `+/-`（正負切替）。
  - クリア: `C`（全クリア）、`CE` または `⌫`（直前1文字削除）。
- 税計算:
  - `税込` / `税抜` ボタンを用意。現在の表示値に対して税率を乗除して即時反映。
  - 標準税率は 10% 固定（初期設定）。将来的な税率変更は拡張扱い。
  - 税率設定画面（10%以外への変更）を提供し、設定値を保持（初期値10%）。
  - 税計算の丸め: 「乗算→小数第3位で四捨五入→小数第2位まで表示」を初期仕様とする（日本の消費税計算慣例に合わせる）。税率変更時も同じ丸めを適用。
- 演算:
  - 四則演算: `+`, `-`, `×`, `÷`。
  - パーセント: 直前の数値に対し「% を押した時点で 1/100 を掛ける」挙動（一般的な電卓の逐次計算モデル）。例: `200 + 10 % =` → 220。`200 × 10 % =` → 20。
  - 連続計算: `=` で演算実行、直前演算の繰り返しに対応。
  - 演算優先: 入力順（一般的な電卓の逐次計算モデル）。必要なら式優先モードは拡張扱い。
- メモリ:
  - `MC`（クリア）、`MR`（リコール）、`M+`（加算）、`M-`（減算）、`MS`（セット）。
  - メモリ状態の有無表示（例: `M`）。
- 入力手段:
  - クリック/タップ操作に対応。
  - キーボード入力をサポート（数字、演算子、Enter/Backspace/Esc）。フォーカス管理とブラウザ標準ショートカットの競合に留意。
- 設定パネル導線:
  - 設定エリアはハンバーガーメニューから開閉できること（初期状態は閉）。
  - モバイルはドロワー、デスクトップはサイドパネルとして開閉可能にする。
  - `Esc`、明示的な閉じる操作（閉じるボタン/背景クリック）で閉じられること。
  - アクセシビリティ属性（`aria-expanded`, `aria-controls`, `aria-label`）を適切に付与する。
- 入力制約:
  - 桁数上限: 整数部は初期設定で最大12桁。超過入力は無視し、表示は最大桁でクリップ。
  - 小数点以下桁: デフォルト表示3桁（内部第4位丸め）、設定で変更可。
  - 履歴件数上限: 初期 50 件。超過時は古いものから削除。
- 表示オプション:
  - 桁区切りの ON/OFF 切替を用意。
  - 表示幅を超える場合は科学表記にフォールバックするモードを追加。
  - 小数精度を任意桁に固定できる設定（表示と計算の丸めを整合させる）。
  - デフォルト精度/丸め: 小数第4位で丸め（四捨五入）て第3位まで保持、表示は第3位まで。必要に応じて設定で変更可。
- 履歴:
  - 直近の計算式と結果をリスト表示し、タップ/クリックで再利用できる。
  - 履歴再利用時は現在の計算コンテキスト（accumulator/pending operator/recent operand）を安全にリセットしてから再利用する。
  - 履歴のクリアとクリップボードコピーをサポート。
- 入力モード切替:
  - 逐次計算モード（現在の挙動）と、演算子優先でまとめて評価する式評価モードを切替可能にする（括弧は現行スコープ外）。
  - 初期デフォルトは逐次計算モード。
  - モード別仕様:
    - 逐次計算モード: 入力順で即時評価し中間結果を保持（標準電卓型）。
    - 式評価モード: 演算子優先でまとめて評価。`=` 押下時に式全体を評価し、エラー時はメッセージ表示＋式を保持。
  - 式評価モードで桁区切り表示が有効でも、後続入力・再評価が破綻しないこと（内部評価値と表示を分離）。
- テーマ:
  - ライト/ダークの切替を提供。
- PWA/オフライン:
  - PWA 対応し、ホーム画面アイコンから起動・オフライン利用を可能にする。
- エラー・例外:
  - ゼロ除算やオーバーフロー時はエラー表示し、明示的なクリアで復帰。
  - エラー中の `CE` 復帰でも、ユーザー設定（税率/精度/表示設定）は保持されること。
  - 入力上限（桁数、表示幅）を決めてバリデーション。超過時は入力を無視または警告表示。

## 非機能要件
- 対応ブラウザ: 最新版の Chrome/Edge/Firefox/Safari。モバイル Safari/Chrome でも主要機能が動作。
- パフォーマンス: 単一ページで即応答。依存ライブラリは最小限。
- レイアウト: レスポンシブ対応（スマホ縦持ちで操作可能なボタンサイズ/間隔）。
- アクセシビリティ: コントラスト確保、ボタンに aria-label 付与、フォーカス移動可。
- ローカル動作: ネットワークなしでも計算本体は利用可能（外部 API 非依存）。
- ログ/分析: 初期スコープではなし。必要なら opt-in で計測を追加。

## データ・状態管理
- 計算状態（現在値、オペランド、演算子、直前の演算結果、メモリ値）をクライアント側で保持。
- 永続化:
  - テーマ、税率設定、表示設定（桁区切り/精度）、モード選好は localStorage 等で保存。
  - 履歴は初期スコープでは永続化しない（セッションのみ）。

## 品質・テスト
- ユニットテスト: 計算ロジック（四則演算、連続計算、メモリ操作、パーセント、エラー処理）。
- 税計算の相互変換（10%での税込⇔税抜）が正しく行われることを確認。
- キーボード操作、履歴再利用、税率変更、表示オプション（桁区切り/精度設定）を含むE2Eシナリオをカバー。
- E2E（任意）: 主要シナリオのクリック操作確認。
- フォーマット/静的解析/型: ESLint, vue-tsc, Vitest を CI 実行。

## 今後の拡張候補（スコープ外）
- 科学関数（sin, cos, pow 等）、複素数。
- 履歴の高度検索/タグ付け、履歴の永続化。
- 式モードでの関数定義やスクリプト的拡張。
- 外部API連携、ログ/分析のデフォルト収集。
