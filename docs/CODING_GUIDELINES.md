# Coding Guidelines (BrowserCalc)

## 目的/範囲
- BrowserCalc (Vue 3 + TypeScript + Vite) のフロントエンド実装ルールを示す。
- docs/REQUIREMENTS.md, docs/DESIGN.md, docs/ARCHITECTURE.md, docs/PLAN.md に従い、本ガイドは補完する立ち位置。

## ベース原則
- オフライン完結のSPAとして、外部APIやバックエンドに依存しない。
- 計算ロジックは副作用を避けた純粋関数を優先し、UI層と明確に分離する。
- 例外やエラー状態を明示的に扱い、境界値（桁上限・丸め・ゼロ除算・オーバーフロー）をテストで担保する。
- レスポンシブとアクセシビリティ（aria, コントラスト, フォーカス移動）を必須要件とする。

## 言語/フレームワーク
- TypeScript を利用し、`any` を避け明示的な型注釈を基本とする。union/enum は狭い型に絞る。
- Vue 3 Composition API + `<script setup>` を使用。options API は新規追加しない。
- JSX/TSX は使わず、`.vue` と純粋関数の`.ts`で構成する。

## 構造と責務分離
- `src/lib`: 計算ロジックや設定操作などの副作用レスな純粋関数を置く（DOMやブラウザAPIに依存しない）。
- `src/components`: UIとイベントハンドラ。ライブラリ層の関数を呼び出し、リアクティブstateを更新するだけに留める。
- 永続化やテーマ適用などブラウザAPIを触る処理は、`lib/settings` 等に集約しコンポーネントから直接触らない。

## Vue/状態管理の指針
- `reactive`/`ref`/`computed` を用い、派生状態はできるだけ `computed` で算出する。不要な重複stateを持たない。
- イベントハンドラは小さく保ち、`lib` の関数で新stateを生成して `mergeState` などで反映するパターンを継続する。
- ウォッチは必要最小限にし、副作用が必要な場合は明示的にコメントで理由を書く。
- キーボードショートカット追加時はブラウザ標準ショートカットとの競合を確認し、`preventDefault` は必要最小限とする。

## 計算/丸め/表示
- 丸め・桁上限・税計算・パーセント挙動は docs/REQUIREMENTS.md, docs/DESIGN.md に沿う。ロジック追加時は共通ヘルパを用いるか抽出する。
- 科学表記や桁区切りの挙動は設定値に従わせ、UI側で無理に書式を変えない。

## UI/アクセシビリティ/スタイル
- すべてのボタンや入力に `aria-label` を付与する。表示部の更新には `aria-live` を適切に設定する。
- コントラスト確保とフォーカスインジケータを維持する。タッチターゲットは最小44px相当を目安にする。
- CSSは既存のトーンを踏襲し、テーマ切替に影響する色はCSS変数やルートセレクタで扱う。ハードコード色を増やす場合はライト/ダーク両方を確認する。

## 依存追加
- ランタイム依存の追加は原則事前合意とADR更新が必要。軽微なdevDependencyのみ追加する場合もPRで理由を明記する。
- 不要なポリフィルや巨大ライブラリは避け、ブラウザ互換は現在のサポート範囲（最新モダンブラウザ）を前提とする。

## テスト/品質
- 計算ロジックはVitestでユニットテストを追加する。境界値とエラー状態をカバーすること。
- PR前に `npm run lint`, `npm run typecheck`, `npm test`（または `make lint`, `make typecheck`, `make test`）を実行する。
- 手動確認が必要なUI変更は、主要シナリオを箇条書きで記録する（例: 設定反映、キーボード操作、レスポンシブ）。

## Git/PR
- ブランチは `feat/<topic>` / `fix/<topic>` / `chore/<topic>` を基本とし、mainは常にデプロイ可能な状態を維持する。
- PRには変更概要とテスト結果を記載し、セルフレビューコメントで意図や判断を補足する。

## 禁止・注意事項
- 破壊的コマンド（`git reset --hard`, 大量削除など）は使わない。状態破壊が必要な場合は必ず相談する。
- 秘密情報や認証情報をコード・ログに含めない。外部通信を追加しない。
