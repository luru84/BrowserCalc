# 実装計画と受け入れ条件（Web電卓）

要件/基本設計をもとに、開発タスクの流れと受け入れ条件（テスト観点を落とし込んだもの）を整理する。

## 実装計画（タスクリスト）
- P0: 環境/CI基盤
  - 依存・lint/typecheck/test のCI確認（済みならスキップ）
- P1: コア計算ロジック
  - 逐次計算ステートマシン（四則/連続`=`/符号反転/クリア/⌫/CE）
  - パーセント挙動（逐次モデル）、税計算（丸め）、桁上限/精度のバリデーション
  - エラー状態遷移（ゼロ除算/オーバーフロー）
  - ユニットテスト整備
- P2: UI骨格
  - 表示エリア/テンキー/演算子/クリア系/符号反転/パーセント/税込・税抜/メモリキー
  - レイアウト（SP縦1カラム、PC 2カラム可）、アクセシビリティ（aria-label, コントラスト）
- P3: 設定機能
  - 税率設定UI（初期10%）、表示設定（桁区切りON/OFF、精度）、テーマ切替（ライト/ダーク/高コントラスト）
  - 設定の永続化（localStorage）
- P4: 履歴
  - 式と結果の保存/上限管理/クリア/コピー/再利用
  - 履歴表示のレスポンシブ対応（モバイルはドロワー/タブ）
- P5: 入力モード切替
  - 逐次計算モードの完了
  - 式評価モード: パーサ（括弧/優先度）、評価、エラー保持
  - モード切替UIと状態保持
- P6: キーボード入力
  - 数字/演算子/Enter/Backspace/Esc、符号反転/税込/税抜のショートカット
  - ブラウザ標準ショートカットとの競合回避
- P7: PWA/オフライン
  - manifest + Service Worker（静的アセットキャッシュ）、オフラインでも計算/設定利用可
  - テーマ/設定の永続確認
- P8: 仕上げ
  - E2E/手動確認（受け入れ条件に沿う）
  - ドキュメント更新（READMEに使い方、ビルド/起動手順）

## 受け入れ条件（主要シナリオベース）
- 四則/逐次計算
  - `2 + 3 =` → 5、続けて `=``=` → 8, 11（直前演算再適用）
  - 符号反転が表示と計算に反映する
  - クリア系: `CE` は現在入力のみ、`C` は全リセット、`⌫` は1文字削除
- パーセント
  - `200 + 10 % =` → 220、`200 × 10 % =` → 20（逐次モデル）
- 税計算と丸め
  - 税込: 表示値×1.10 を「第3位四捨五入→第2位表示」で反映
  - 税抜: 表示値÷1.10 を同丸めで反映
  - 税率を変更すると税込/税抜に反映される
- 精度/表示
  - デフォルト精度（表示3桁/内部第4位丸め）で表示され、桁区切りON/OFFが効く
  - 表示幅超過時に科学表記へフォールバック（設定が有効な場合）
- メモリ
  - `MS/MR/MC/M+/M-` が期待通り動作し、`M` インジケータが表示/消失する
- 履歴
  - `=` 実行で式と結果が履歴に入り、上限件数超過で古いものが削除
  - 履歴選択で値が再利用され、コピーがクリップボードに入る
- モード切替
  - 逐次 ↔ 式評価の切替ができ、式評価モードで括弧/優先度が正しく評価される
  - 式評価でエラー時、式が保持され、メッセージ表示のまま修正再評価できる
- キーボード
  - 数字/演算子/Enter/Backspace/Esc で主要操作ができ、不要にブラウザショートカットを阻害しない
  - 税込/税抜/符号反転ショートカットが動作（設定で無効化も可なら確認）
- エラー・制約
  - ゼロ除算/オーバーフローでエラー表示し、`C` で復帰する
  - 整数12桁・精度上限を超える入力は無視またはクリップされる
- 永続化
  - テーマ、税率、表示設定、モード選好がリロード後も保持される
  - 履歴はリロードで消える（初期スコープ）
- PWA/オフライン
  - インストール可能（manifest），オフラインでも計算と設定が機能する
- アクセシビリティ/レスポンシブ
  - ボタンに aria-label, コントラスト確保、フォーカス移動可能
  - モバイル縦で主要キーがタップしやすく、デスクトップで2カラム表示が崩れない
