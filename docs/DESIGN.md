# 基本設計（Web電卓）

要件定義（docs/REQUIREMENTS.md）に基づく基本設計。クライアントサイド SPA とし、計算状態はブラウザ内で完結させる。

## 全体構成
- 表示部: 現在値/結果、直前演算子、メモリインジケータ（`M`）、エラー表示を含む。
- 入力部: 数字キー、小数点、クリア（C/CE/⌫）、符号反転、演算子（+/-/×/÷）、パーセント、税込/税抜、メモリキー（MC/MR/M+/M-/MS）、モード切替（逐次/式評価）、表示設定（桁区切りON/OFF、精度）、テーマ切替。
- オプション部: 税率設定（初期10%）、表示設定ウィジェット、履歴一覧（式と結果、再利用/コピー）。
- アプリ構造: プレゼンテーション（UI）と計算ロジック（ステートマシン）を分離。ロジックは純粋関数ベースを優先。

## UI/レイアウト概要
- 画面構成: 上部に表示エリア（現在値・エラー・インジケータ）、中段にテンキー+演算子、下部/側面にメモリ・税込/税抜・モード切替・設定・履歴。
- モバイル: 縦1カラム。テンキーをメイン領域に置き、履歴/設定はドロワーまたはタブ切替。
- デスクトップ: 横幅があれば表示+テンキーを左、履歴/設定/テーマを右カラムで表示する2カラム構成。
- ブレークポイント目安: 768px 未満をモバイル、768px 以上で2カラム化を許容。

## 状態（シングルストア想定）
- `displayValue`: 表示中の文字列/数値。入力・計算結果を反映。
- `accumulator`: 直前までの計算結果または左オペランド。
- `pendingOperator`: 未実行の演算子（逐次計算モードで利用）。
- `recentOperand`: 直前の右オペランド（`=` 繰り返し用）。
- `memoryValue`: メモリ格納値（存在フラグで `M` 表示）。
- `mode`: `sequential`（逐次計算） / `expression`（式評価）。
- `history`: [{式文字列, 結果}] の配列。上限件数を決め、古いものから削除。
- `format`: {`grouping`: bool, `precision`: number, `scientificFallback`: bool}。
- `taxRate`: 税率（初期 0.10）。
- `error`: エラー状態（メッセージ/コード）。エラー時は入力制御を制限し、`C` で解除。

## 状態遷移（逐次計算モードの例）
| イベント | 事前状態 | 遷移/更新 | 備考 |
|---|---|---|---|
| 数字/小数入力 | error=null | displayValue を連結/上書き（桁上限チェック） | 新規入力フラグで上書き |
| 演算子入力 | pendingOperatorが存在 | accumulator (pendingOperator displayValue) を計算→表示、pendingOperatorを新演算子に置換 | recentOperand = displayValue |
| '=' | pendingOperatorが存在 | accumulator (pendingOperator (recentOperand or displayValue)) を計算→表示 | '=' 連打時は recentOperand を再利用 |
| '%' | いずれか | displayValue = displayValue / 100 | 逐次モデル |
| 税込/税抜 | いずれか | displayValue = displayValue * (1+taxRate) または ÷(1+taxRate) | 税計算丸め適用 |
| クリア系 | - | CE: displayValue を 0/空に、C: state全体を初期化、⌫: 1文字削除 | エラー状態も解除 |
| メモリ操作 | - | memoryValue をセット/加減算/クリア、MRで表示にロード | memory インジケータ更新 |
| エラー発生 | ゼロ除算等 | error をセットし、入力をブロック | C で解除 |

## UIコンポーネント構成（案）
- Display: 現在値/エラー/インジケータ（演算子、`M`）。
- Keypad: 数字（0-9, .）、演算子（+ - × ÷）、`=`、符号反転、パーセント、クリア系（C/CE/⌫）。
- Tax/Misc: `税込` / `税抜`、設定/モード切替トグル。
- Memory: `MC` `MR` `MS` `M+` `M-`。
- Settings Panel: 税率設定、表示設定（桁区切り/精度/科学表記）、テーマ切替。
- History Panel: 履歴一覧、再利用/コピー/クリア。モバイルはドロワー、デスクトップはサイド。
## 表示・丸め・フォーマット
- 丸めデフォルト: 小数第4位で四捨五入し第3位まで保持・表示（設定で変更可）。
- 税計算丸め: 乗算後に小数第3位で四捨五入し第2位表示（消費税慣例）。
- 桁区切り: `format.grouping` でON/OFF。表示幅超過時は科学表記へフォールバック（`scientificFallback`）。
- エラー時: `E` or メッセージを表示し、計算入力を無効化（クリア操作のみ有効）。

## 挙動（逐次計算モード）
- 数字入力/小数点: `displayValue` をビルド。新規入力開始フラグで上書き、継続時は連結（上限桁を超えたら無視）。
- 演算子入力: `accumulator` と `pendingOperator` があれば即時計算し結果を表示、次の演算子を `pendingOperator` に保持。無ければ `accumulator = displayValue` をセット。
- `=`: `pendingOperator` と `recentOperand` を使い計算→表示。以降の `=` 繰り返しで同じ演算・オペランドを適用。
- `%`: 直前の入力値を 1/100 にして反映。例: `200 + 10 % =` → 220、`200 × 10 % =` → 20。
- 税計算: `税込` は `displayValue * (1 + taxRate)`、`税抜` は `displayValue / (1 + taxRate)`。税計算丸めルールを適用。
- 符号反転: `displayValue *= -1`。
- クリア系: `CE` は現在入力のみリセット、`C` は全状態（accumulator/pendingOperator/recentOperand/error）をリセット。`⌫` は1文字削除（単独の "0" になったら0に戻す）。
- メモリ: `MS`=セット、`MR`=表示へロード、`MC`=クリア、`M+`/`M-`=加減後セット。`memoryValue` 有無で `M` 表示。
- 履歴: `=` 実行後に {式,結果} を push（上限超過で古いもの削除）。履歴項目を選択すると `displayValue` にセット、可能なら演算再利用。
- キーボード: 数字/演算子/Enter/Backspace/Esc を対応し、ブラウザ標準ショートカットとの衝突を避ける。

## 挙動（式評価モード）
- 入力をトークナイズし、演算子優先で構文木を生成（括弧は現行スコープ外）。`=` 押下で一括評価。
- エラー（構文、ゼロ除算等）はメッセージ表示し、式は保持。`C` でリセット。
- パーセント/税計算は現在値への単項演算として適用。

### 式評価モードの仕様（詳細）
- 対応演算子: `+`, `-`, `*`, `/`, `%`（単項）。括弧は未対応。
- 優先順位: 単項（符号/パーセント/税） > 乗除 > 加減。左結合。
- トークン制約: 数値（整数・小数）と演算子のみを許可。空白は無視。その他文字があれば構文エラー。
- パーセント: トークン単位の単項演算として 1/100 を掛ける（数値リテラル直後に付与可能）。
- 税込/税抜: 現在値への単項演算として適用（表示入力を税率換算）。式内の `税込`/`税抜` は初期スコープ外。
- エラー時の式保持: 構文エラーでも入力済み式は保持し、修正して再評価できる。

## 入力制約・上限
- 桁数: 整数部は最大12桁を初期設定。超過入力は無視し、表示は最大桁でクリップ。
- 小数: デフォルト精度（表示3桁/内部第4位丸め）。小数点以下の最大桁数は精度設定に従う。
- 履歴: 上限 50 件（暫定）。超過時は先頭から削除。
- 入力無効化: エラー状態時は数値/演算入力を無効化し、クリア系のみ受け付ける。

## エラーメッセージ方針
- ゼロ除算: 「Cannot divide by zero」など短文で表示し、エラー状態へ。
- オーバーフロー/桁超過: 「Overflow」表示。計算は打ち切り、クリアで復帰。
- 構文エラー（式評価モード）: 「Syntax error」表示し、式を保持。修正後再評価可。
- 共通: エラー中は `C` 以外の計算操作をブロック。

### エラーメッセージ一覧（例）
| コード | メッセージ | 発生条件 |
|---|---|---|
| DIV_ZERO | Cannot divide by zero | 0除算 |
| OVERFLOW | Overflow | 桁/範囲超過 |
| SYNTAX | Syntax error | 式評価モードでのトークン不整合 |
| INVALID_TOKEN | Invalid character | 許容外文字を検出 |

## キーマップ（例）
- 数字: `0-9`
- 小数点: `.`
- 演算子: `+ - * /`
- 実行: `Enter`（=`）
- クリア: `Esc` or `c`（全クリア）、`Backspace`（⌫）
- 符号反転: `n`（negate）など任意。競合しないキーを割当。
- 税込/税抜: `t`（税込）、`shift+t`（税抜）など任意。設定で無効化可能。
- モード切替: `m`（逐次/式評価のトグル）など任意。

## 永続化/PWA
- localStorage 等に保存: テーマ（ライト/ダーク）、税率設定、表示設定（桁区切り/精度）、モード選好（逐次/式評価）。
- 履歴は初期スコープでは永続化しない（セッション内のみ）。
- Service Worker で静的アセットをキャッシュし、オフライン起動を許容。

## 非機能・UI
- レスポンシブ: スマホ縦持ちで主要キーが親指で届く配置。ボタン間隔と最小タッチサイズを確保。
- テーマ: ライト/ダーク切替。テーマ状態を永続化（localStorage）。
- PWA: マニフェスト+Service Workerでオフライン起動。計算/設定はローカルで完結。
- アクセシビリティ: コントラスト確保、すべてのボタンに aria-label 付与、キーボードフォーカス移動可（ショートカットとの競合を避ける）。
- ログ/分析: 初期スコープでは収集しない。導入時は opt-in 設定を設ける。
- 外部依存: 計算は外部APIに依存しない。オフラインで完結する。

## 受け入れ条件（主要シナリオ）
- 四則演算が逐次計算モードで正しく動作し、`=` 繰り返しが直前演算を再適用する。
- `%` の挙動が逐次計算モデル通り（例: `200 + 10 % =` → 220、`200 × 10 % =` → 20）。
- 税込/税抜がデフォルト税率（10%）と丸め仕様で相互変換し、税率変更後も反映される。
- メモリ（MS/MR/MC/M+/M-）が正しく格納/呼び出しされ、`M` インジケータが表示される。
- キーボード入力で主要操作（数字/演算子/Enter/Backspace/Esc/%）が行え、ブラウザ標準ショートカットは不必要に阻害しない。
- 履歴への保存と再利用、クリア、コピーが機能し、上限件数を超えると古いものが削除される。
- モード切替（逐次↔式評価）が動作し、式評価では演算子優先で正しく評価、エラー時に式を保持する（括弧は未対応）。
- テーマ切替と表示設定（桁区切り/精度）が反映され、永続化される。オフラインでも計算できる。

## テスト観点
- ユニット: 四則演算、逐次計算の連続 `=`, パーセント挙動、税込/税抜丸め、メモリ操作、丸め/精度設定、エラー処理。
- E2E: クリック/タップとキーボード操作、履歴再利用、モード切替（逐次↔式評価）、テーマ/表示設定切替、PWAオフライン起動（任意）。

## 設計上の留意
- 計算ロジックは副作用を避け、UIから独立してテスト可能にする。
- 表示フォーマットと内部計算値の乖離を避ける（丸めポイントを明示）。
- 履歴や設定は保存上限・バリデーションを設け、破損時は安全に初期化。
- スコープ外（初期リリース対象外）: 科学関数、複素数、履歴の高度検索/タグ付け、履歴の永続化、式モードでの関数定義、外部API連携、ログ/分析のデフォルト収集。
