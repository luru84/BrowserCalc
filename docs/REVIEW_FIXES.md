# レビュー指摘の修正内容

最終更新日: 2026-02-16
対象ファイル: `src/lib/calculator.ts`

## 1. 桁区切り表示値の数値変換失敗 (P1)
- 指摘箇所: `src/lib/calculator.ts:329`
- 問題:
  - `grouping` 有効時、`displayValue` に `1,234` のような文字列が入り、`Number("1,234")` が `NaN` になる。
  - その結果、`+`、`MS`、`M+`、`M-`、履歴再利用など、表示値を数値化する処理が失敗する。
- 修正内容:
  - `toNumber` で数値変換前に桁区切り文字（`,`）を除去してからパースする。
  - 必要に応じて前後空白も除去し、空文字は `null` 扱いにする。
- 確認観点:
  - 例: `1234` 表示が `1,234` の状態で `+ 1 =` が `1,235` になる。
  - `MS` / `M+` / `M-` が `1,234` 表示状態でも正常動作する。

## 2. clearAll で実行時設定が初期化される問題 (P2)
- 指摘箇所: `src/lib/calculator.ts:53`
- 問題:
  - `clearAll` が状態をデフォルト再生成しており、`taxRate` / `precision` / `grouping` / `scientific` が意図せず初期値に戻る。
- 修正内容:
  - `clearAll` 実行時は「計算コンテキストのみ」初期化し、ユーザー設定は現行値を保持する。
  - 具体的には、上記設定項目を現在の `state` から引き継いで新しい状態を構築する。
- 確認観点:
  - 例: `precision=6` に変更後 `C` 押下しても `precision=6` のまま。
  - `grouping` / `scientific` / `taxRate` も `C` で変化しない。

## 3. 式モードの小数点入力制御が式全体ベース (P2)
- 指摘箇所: `src/lib/calculator.ts:96`
- 問題:
  - `state.displayValue.includes('.')` で判定しているため、式内で一度 `.` を使うと後続オペランドに `.` を入力できない。
- 修正内容:
  - 小数点の重複判定を「式全体」ではなく「現在入力中のオペランド単位」に変更する。
  - 演算子区切りで現在オペランドを取り出し、そのオペランド内に `.` がある場合のみ入力を拒否する。
- 確認観点:
  - `1.2+3.4`、`10.05*2.1` が入力可能。
  - `1..2` や `3.4.5` のような同一オペランド内重複は拒否される。

## 補足
- 優先度は P1 -> P2 の順で対応する。
- すべての修正後、該当入力フローの回帰確認（四則演算、メモリ操作、式入力）を実施する。

## 追加回収項目（2ndレビュー）
対象日: 2026-02-16

### 4. 式評価モードで桁区切り表示後の継続演算が失敗
- 問題:
  - `grouping=ON` かつ式評価モードで `=` 後の表示が `1,234` になり、後続で `+` を押すと評価時に `,` が混入して失敗する。
- 修正内容:
  - 評価に使う式文字列は桁区切り記号を除去した内部表現で扱う。
  - もしくは表示用文字列とは別に評価用バッファを保持し、表示フォーマットと分離する。
- 確認観点:
  - `grouping=ON` で `1234` → `=` → `+1=` が成功する。

### 5. エラー中の CE で設定が初期化される
- 問題:
  - エラー状態で `CE` した際、設定値（税率/精度/表示）がデフォルトへ戻る経路が残っている。
- 修正内容:
  - エラー復帰時も現在設定を引き継いだ初期化に統一する。
- 確認観点:
  - 設定変更後にエラー発生→`CE` で復帰しても設定値が保持される。

### 6. 履歴再利用で逐次計算コンテキストが残る
- 問題:
  - 履歴の再利用時に `displayValue` だけ更新し、`accumulator/pendingOperator/recentOperand` が残ると意図しない演算につながる。
- 修正内容:
  - 履歴再利用時は計算コンテキストをリセットし、再入力開始状態にする。
- 確認観点:
  - 演算途中で履歴再利用しても、以前の演算状態が混入しない。

### 7. モード選好（逐次/式評価）の永続化不足
- 問題:
  - 逐次/式評価モードの選好が保存されず、リロードで初期化される。
- 修正内容:
  - 設定モデルにモード選好を追加して永続化対象に含める。
- 確認観点:
  - モード切替後に再読み込みしても同じモードで起動する。

### 8. 設定パネルのハンバーガーメニュー化
- 問題:
  - 設定パネルが常時下部表示で、モバイル操作時に主操作の視認性・到達性が落ちる。
- 修正内容:
  - 設定導線をハンバーガーボタンへ移し、モバイルはドロワー、PCはサイド開閉にする。
  - `Esc`、背景クリック、閉じるボタンを閉鎖導線として提供する。
- 確認観点:
  - 初期は閉状態、ハンバーガーで開閉可能、A11y属性が適切に付与される。
