# レビュー指摘の修正内容

最終更新日: 2026-02-16
対象ファイル: `src/lib/calculator.ts`

## 1. 桁区切り表示値の数値変換失敗 (P1)
- 指摘箇所: `src/lib/calculator.ts:329`
- 問題:
  - `grouping` 有効時、`displayValue` に `1,234` のような文字列が入り、`Number("1,234")` が `NaN` になる。
  - その結果、`+`、`MS`、`M+`、`M-`、履歴再利用など、表示値を数値化する処理が失敗する。
- 修正内容:
  - `toNumber` で数値変換前に桁区切り文字（`,`）を除去してからパースする。
  - 必要に応じて前後空白も除去し、空文字は `null` 扱いにする。
- 確認観点:
  - 例: `1234` 表示が `1,234` の状態で `+ 1 =` が `1,235` になる。
  - `MS` / `M+` / `M-` が `1,234` 表示状態でも正常動作する。

## 2. clearAll で実行時設定が初期化される問題 (P2)
- 指摘箇所: `src/lib/calculator.ts:53`
- 問題:
  - `clearAll` が状態をデフォルト再生成しており、`taxRate` / `precision` / `grouping` / `scientific` が意図せず初期値に戻る。
- 修正内容:
  - `clearAll` 実行時は「計算コンテキストのみ」初期化し、ユーザー設定は現行値を保持する。
  - 具体的には、上記設定項目を現在の `state` から引き継いで新しい状態を構築する。
- 確認観点:
  - 例: `precision=6` に変更後 `C` 押下しても `precision=6` のまま。
  - `grouping` / `scientific` / `taxRate` も `C` で変化しない。

## 3. 式モードの小数点入力制御が式全体ベース (P2)
- 指摘箇所: `src/lib/calculator.ts:96`
- 問題:
  - `state.displayValue.includes('.')` で判定しているため、式内で一度 `.` を使うと後続オペランドに `.` を入力できない。
- 修正内容:
  - 小数点の重複判定を「式全体」ではなく「現在入力中のオペランド単位」に変更する。
  - 演算子区切りで現在オペランドを取り出し、そのオペランド内に `.` がある場合のみ入力を拒否する。
- 確認観点:
  - `1.2+3.4`、`10.05*2.1` が入力可能。
  - `1..2` や `3.4.5` のような同一オペランド内重複は拒否される。

## 補足
- 優先度は P1 -> P2 の順で対応する。
- すべての修正後、該当入力フローの回帰確認（四則演算、メモリ操作、式入力）を実施する。
